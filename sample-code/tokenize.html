<html>
    <head>
        <meta charset="UTF-8">
    <!--
        Copyright (c) 2014-2018 Auric Systems International. All rights reserved.
        License: 3-Clause BSD License
     -->

     <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
     <script src="./js/sha512.js"></script>
     <script>
         /* Utility Functions
            In production, all this JavaScript would be served by externally
            loaded scripts. Shown here inline to simplify the sample code.
          */
         "use strict";

         var vault_url = 'https://vault02-sb.auricsystems.com/vault/v2/';

         function toHex(str) {
             var hex = '';
             for(var i=0;i<str.length;i++) {
                 hex += ''+str.charCodeAt(i).toString(16);
             }
             return hex;
         }

         /*
          * JavaScript UUID Generator, v0.0.1
          *
          * Copyright (c) 2009 Massimo Lombardo.
          * Dual licensed under the MIT and the GNU GPL licenses.
          * https://forum.jquery.com/topic/jquery-what-do-you-recommend-to-generate-uuid-with-jquery
          * NOTE from ASI: Math.random is sufficiently random for this tracking purpose.
          */
         function uuid4() {
             var uuid = (function () {
                 var i,
                     c = "89ab",
                     u = [];
                 for (i = 0; i < 36; i += 1) {
                     u[i] = (Math.random() * 16 | 0).toString(16);
                 }
                 u[8] = u[13] = u[18] = u[23] = "-";
                 u[14] = "4";
                 u[19] = c.charAt(Math.random() * 4 | 0);
                 return u.join("");
             })();
             return {
                 toString: function () {
                     return uuid;
                 },
                 valueOf: function () {
                     return uuid;
                 }
             };
         };


         /* String Substitution */
         String.prototype.format = function() {
             var formatted = this;
             for( var arg in arguments ) {
                 formatted = formatted.replace("{" + arg + "}", arguments[arg]);
             }
             return formatted;
         };


         /* UTC Timestamp (in seconds) */
         function utcTimestamp() {
             var x = new Date();
             return Math.floor((x.getTime()) / 1000).toString();
         };


         /*  Random Ajax transaction identifier. Between 0 and 1,000,000.
             NOTE: ajax_id MUST be an integer, not a string.
          */
         function generateAjaxId() {
             return Math.floor((Math.random() * 1000000) + 1);
         };

         $(document).ready(function() {
             /* Bind to the button. */
             $("#credentials").submit(function(event) {
                 /* need to call prevent-default because the Ajax call is asynchronous */
                 event.preventDefault();

                 // Gather the data.
                 var configuration = $("#credentials input[name=configuration]").val();
                 var mtid = $("#credentials input[name=mtid]").val();
                 var segment = $("#credentials input[name=segment]").val();
                 var secret = $("#credentials input[name=secret]").val();
                 var retention = $("#credentials input[name=retention]").val();

                 /* Get us a session. */
                 ajaxGetSession(configuration, mtid, segment, retention, secret);

                 /* ajaxTokenize is async. We will come back here and exit.
                    That's why we needed to do event.preventDefault() above.
                  */
             });

             $("#tokenize").click(function(event){
                  event.preventDefault();

                  ccRequestId =  validateCreditCard();
             });
         });

         //keep track of the creditcardvalidation request id
         var ccRequestId = "";

         function validateCreditCard(){

             //A sample request ID
             var requestId = "isCreditCardValid:" + Math.random();
             var msg = {
                 tag: "isCreditCardValid",
                 data: requestId
             };
//             console.log(msg);
             sendMessage(msg);
             return requestId;
         }
         function ajaxGetSession(configuration, mtid, segment, retention, secret) {
             $("#auv_message").text("");
             var params = {
                 "id": generateAjaxId(),
                 "method": "get_session",
                 "params": [{
                     "utcTimestamp": utcTimestamp(),
                     "configurationId": configuration,
                     "mtid": mtid,
                     "retention": retention,
                     "segment": segment
                     }]
                 };
             var vault_trace_uid = uuid4();
             var json_data = JSON.stringify(params)
             var hex_secret = toHex(secret)
             var hash = new jsSHA("SHA-512", "TEXT")
             hash.setHMACKey(hex_secret, "HEX")
             hash.update(json_data)
             var hmac = hash.getHMAC("HEX")

             $.ajax({
                 type: 'POST',
                 url: vault_url,
                 beforeSend: function(xhr) {
                     xhr.setRequestHeader("X-VAULT-HMAC", hmac);
                     xhr.setRequestHeader("X-VAULT-TRACE-UID", vault_trace_uid);
                     },
                 crossDomain: true,
                 dataType: 'json',
                 timeout: 1000 * 5,
                 data: json_data,
                 success: function(data, textStatus, jqXHR) {
                     var json = JSON.stringify(data);
                     var las = data['result']['lastActionSucceeded'];
                     if(0 == las) {
                        console.log('Problem..');
                        // alert("We've experienced a processing error. Please try again.");
                         /* This would be a good place to log an error
                            using whatever error tracking system you have.

                            Never show the following alert in production.
                          */
                         alert(data['error']);
                     } else {
                         /* Load the embedded iFrame */
                         console.log('SUCCESS!!');

                         var sessionId = data['result']['sessionId'];
                         var cardtypes = $("#cardTypes").val();

                        $('#embedded').attr(
                             'src',
                             '../embedded-tokenize.html?sessionID=' + sessionId +
                             '&vault_trace_uid=' + vault_trace_uid +
                             '&cardTypes=' + cardtypes);
                     };
                 },
                 error: function(jqXHR, textStatus, errorThrown) {
                     console.log('ISSUES!!');
                     // Another good place to log an error.
                     // alert("We've experienced a processing error. Please try again.");
                     // Never show alert in production.
                     alert(errorThrown);
                 },
             });
         }

         function tokenize(){
             // Validation returned successfully.
             // Send tokenization request to iFrame.
             var msg = {
                 tag: "tokenize"
             };

             sendMessage(msg);

         }
     </script>


     <style>
        #embedded { width: 350px; height: 170px;}
     </style>
    </head>
    <body>
        <noscript>JavaScript Required</noscript>
        <h1>Browser-Only Demonstration</h1>
        <div>In production the Get Session call occurs on the server, never in the browser.</div>
        <hr />
        <form id='credentials'>
            Configuration: <input type="text" name="configuration" value=""><br />
            MTID: <input type="text" name="mtid" value=""><br />
            Segment: <input type="text" name="segment" value=""><br />
            Retention: <input type="text" name="retention" value="big-year"><br />
            Secret: <input type="password" name="secret" value=""><br />
            <input type="submit" id="credentials" value="Get Session"><br />

            <hr />
            <div>URL parameters when loading the embedded iFrame.</div>
            <div>Would not appear on parent page.</div>
            <div>
                Limit to CardTypes: <input type="text" id="cardTypes" name="cardTypes" value="AM,DS,MC,VI"></input>
            </div>
            <br />
            <hr />
            <div>Tokenize button is displayed on parent page.<br />Calls the embedded iFrame.</div>
            <input type="button" id="tokenize" value="Tokenize"/>
        </form>

        <!-- <iframe id="embedded" src="embedded-tokenize.html?"></iframe> -->
        <iframe id="embedded" src=""></iframe>

        <hr />
        <div id="auv_message"></div>
        <script type="text/javascript">

                var embeddedTokenizer = document.getElementById("embedded");

                //send message to iframe
                var sendMessage = function(msg) {
                    embeddedTokenizer.contentWindow.postMessage(msg, "*");
                }

                function bindEvent(element, eventName, eventHandler) {
                    if (element.addEventListener){
                        element.addEventListener(eventName, eventHandler, false);
                    } else if (element.attachEvent) {
                        element.attachEvent('on' + eventName, eventHandler);
                    }
                }

                bindEvent(window, "message", function(e){
                    //console.log(e);
                    var tag = e.data.tag || "";
                    var data = e.data.data;

                    if (tag == "auv_ok"){
                        auv_ok(data.token, data.cardType)
                    } else if (tag == "auv_error"){
                        auv_error(data.code, data.message);
                    } else if (tag == "auv_timeout"){
                        auv_timeout();
                    } else if (tag == "cc_valid"){
                        creditcard_valid(data.requestId, data.isValid);
                    }

                })

                function show_auv_message(msg){
                    $("#auv_message").text(msg);
                }

                //API functions
                function auv_ok(token, card_type){
                    $('#embedded').attr('src', '');
                    var msg = "Tokenization succeeded: token: " + token + ", card type: " + card_type;
                    show_auv_message(msg);
                }

                function auv_timeout(){
                    $('#embedded').attr('src', '');
                    show_auv_message("AUV request timed out.");

                }
                function auv_error(error_code, error_message){
                    $('#embedded').attr('src', '');
                    var msg = "AUV request failed. Code: " + error_code + ", error: " + error_message;
                    show_auv_message(msg);
                }
                function creditcard_valid(requestId, isValid){
                    //message from embedded iframe indicating whether
                    //a credit card is valid or not. This message is generated in response
                    //to a isCreditCardValid request identified by the request id
                    //Further action can be taken here based on that response

                    //now tokenize of valid and requestId matches
                    if (isValid && requestId === ccRequestId) {
                        console.log("Credit card data is valid. Tokenizing...")
                        tokenize();
                    }
                    else {
                        var msg = "Credit card data is not valid.";
                        show_auv_message(msg);
                    }
                }
            </script>

    </body>
</html>
